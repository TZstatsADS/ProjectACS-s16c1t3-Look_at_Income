---
title: "Cyc1-3_Report"
author: "Team 3"
date: "January 27, 2016"
output:
  html_document:
    pandoc_args: [
      "+RTS", "-K64m",
      "-RTS"
    ]
---

Need to adjust income PINCP by ADJINC     7      
Adjustment factor for income and earnings dollar amounts (6 implied decimal places)
           1007549 .2013 factor (1.007549)



This is a test to see if the lock on the repository affects uploading a document.
```{r warning = FALSE, message=FALSE}
library(rgl)
library(knitr)
knit_hooks$set(webgl = hook_webgl)
library(dplyr)
library(data.table)
library(ggplot2)
library(grid)
library(gridExtra)
library(Rmisc)
library(sitools)
library(hexbin)

# set your local working directory

#setwd("~/Downloads/2013-american-community-survey/pums")
setwd("/Users/bobminnich/Documents/Columbia/Courses/Applied_Data_Science/Data")

# read .csv files and make complete datasets

pdata1 <- fread("ss13pusa.csv")
pdata2 <- fread("ss13pusb.csv")
#hdata1 <- fread("ss13husa.csv")
#hdata2 <- fread("ss13husb.csv")
pus <- rbind(pdata1, pdata2)
#hus <- rbind(hdata1, hdata2)

# pick up our predictors and dependent variables


pus$real <- as.numeric(pus$ADJINC)  * as.numeric(pus$PINCP) * as.numeric(pus$PWGTP)/sum(pus$PWGTP)
pus$as.numeric(pus$PWGTP)/sum(pus$PWGTP)
```

    Educational Attainment - SCHL
  bb .N/A (less than 3 years old)
  
Ability to speak English - ENG
    Ability to speak English
           b .N/A (less than 5 years old/speaks only English)
           1 .Very well
           2 .Well
           3 .Not well
           4 .Not at all

Recoded detailed race code - RAC1P
    Recoded detailed race code
           1 .White alone                             
           2 .Black or African American alone         
           3 .American Indian alone                   
           4 .Alaska Native alone                     
           5 .American Indian and Alaska Native tribes specified; or American
             .Indian or Alaska Native, not specified and no other races
           6 .Asian alone                             
           7 .Native Hawaiian and Other Pacific Islander alone
           8 .Some Other Race alone                   
           9 .Two or More Races           

Data Dictionary: http://www2.census.gov/programs-surveys/acs/tech_docs/pums/data_dict/PUMSDataDict13.txt

Want to look at hours worked per week vs income
JWMNP - Travel time to work
WKHP - Usual hours worked per week past 12 months
JWDP - Time of departure for work 
JWAP - Time of Arrival at work
PINCP - Total person's income (signed) ADJINC     7      
Adjustment factor for income and earnings dollar amounts (6 implied decimal places)
           1007549 .2013 factor (1.007549)

```{r}
library(hexbin)
pus_work <- select(pus,JWMNP,WKHP,JWDP,JWAP,PINCP,SEX, RAC1P, ENG, real)
pus_work <- cbind(pus_work, data.frame(pus)[,204:283])
#remove NAs for WKHP

na.hrs = which(!(is.na(pus_work$JWMNP)+is.na(pus_work$PINCP)))
pwork_hrs = data.frame(pus_work[na.hrs,])
pwork_hrs$SEX_T[pwork_hrs$SEX == 1] = "M"
pwork_hrs$SEX_T[pwork_hrs$SEX == 2] = "F"
```

```{r}
library(survey)
df = data.frame(pwork_hrs)
#add in Weight Columns
df$RAC1P = factor(df$RAC1P)
df$SEX = factor(df$RAC1P)

na.check = df%>%
              is.na() %>%
              apply(2,sum)

acsdesign<-svrepdesign(weights= ~PWGTP, repweights=df[,204:283], type="BRR", rscale = 4/80,data=df, combined=TRUE)

WKHP_mean = svymean(~WKHP, acsdesign, na.rm=T)
WKHP_quant = svyquantile(~WKHP, acsdesign, c(.25,.5,.75), na.rm=T)
            
JWMNP_mean = svymean(~JWMNP, acsdesign, na.rm=T)
JWMNP_quant = svyquantile(~JWMNP, acsdesign, c(.25,.5,.75), na.rm=T)

real_mean = svymean(~real, acsdesign, na.rm=T)
real_quant = svyquantile(~real, acsdesign, c(.25,.5,.75), na.rm=T)

```


```{r warning = FALSE}
races = c("White","Black","American  Indian","Alaska Native","American and Alaskan ","Asian","Native Hawaiian","Some Other Alone", "Two or More")
races_num = c(1:9)

#p = density(log(pwork_hrs$real))
#plot(p)
for (i in seq(0,9,1)){
    if(i == 0){
        MainTitle = paste("Density Plots Male (Blue) vs Female (Red) - Total Poplation")
        plot_df = pwork_hrs
    }else{
        MainTitle = paste("Density Plots Male (Blue) vs Female (Red) - ", races[i])
        plot_df = filter(pwork_hrs, RAC1P == i)
    }

    #Travel time to work
  a = ggplot(plot_df, aes(x=JWMNP,fill=factor(SEX_T))) +
    geom_density(alpha=.4, adjust = 2, trim = FALSE) + 
    xlab("Minutes of Travel to Work") + 
    ylab("Density") +
    xlim(0,75) + 
    guides(fill=FALSE) + 
    geom_vline(xintercept = JWMNP_mean[1]) + 
    geom_vline(xintercept = JWMNP_quant[1:3],colour="green",linetype = "longdash")
  
  #Work Hours per Week
  b = ggplot(plot_df, aes(x=WKHP, fill=factor(SEX_T))) +
    geom_density(alpha=.4, adjust = 2) +
    xlim(0,80) + xlab("Work Hours Per Week") + 
    guides(fill=FALSE)+ 
    theme(axis.title.y = element_blank()) + 
    ylim(0,0.1)+
    geom_vline(xintercept = WKHP_mean[1]) + 
    geom_vline(xintercept = WKHP_quant[1:3],colour="green",linetype = "longdash")
  
  #Personal Income
  
  c = ggplot(plot_df, aes(x=real, fill=factor(SEX_T))) +
    xlab("Personal Income")+ 
    theme(axis.title.y = element_blank())+
    geom_density(alpha=.4,adjust=2) +
    labs(fill = "Sex")+  
    scale_x_continuous(labels=f2si, limits = c(0,120000)) + 
    guides(fill=FALSE) +
    geom_vline(xintercept = real_mean[1]) + 
    geom_vline(xintercept = real_quant[1:3],colour="green",linetype = "longdash")
  
  grid.newpage()
  pushViewport(viewport(layout = grid.layout(2, 3, heights = unit(c(0.5, 5), "null"))))
  grid.text(MainTitle, vp = viewport(layout.pos.row = 1, layout.pos.col = 1:3))
  print(a, vp = viewport(layout.pos.row = 2, layout.pos.col = 1),newpage=FALSE)
  print(b, vp = viewport(layout.pos.row = 2, layout.pos.col = 2),newpage=FALSE)
  print(c, vp = viewport(layout.pos.row = 2, layout.pos.col = 3),newpage=FALSE)
  popViewport(1)
}
```


```{r}
library(rpart)
library(rpart.plot)
set.seed(1)
pwork_hrs_est = pwork_hrs
pwork_hrs_est$SEX = factor(pwork_hrs$SEX)
pwork_hrs_est$RAC1P = factor(pwork_hrs$RAC1P)

train_in = sample(c(1:nrow(pwork_hrs)), floor(0.8*nrow(pwork_hrs_est)))

train = pwork_hrs_est[train_in,]
test = pwork_hrs_est[-train_in,]

fit <- rpart(PINCP ~ SEX + JWMNP + WKHP + RAC1P , data=train, method = "anova")
#pred <- predict(fit, newdata=test)
#correct = sum(pred == test$SEX)/nrow(test)
#print(correct)
rpart.plot(fit)


```

```{r}
fit = lm(PINCP ~ SEX + JWMNP + WKHP + RAC1P , data=train)
summary(fit)
```


```{r testgl1, webgl=TRUE, echo = FALSE,  Eval = FALSE, message= FALSE, results="hide", fig.align='center'}
open3d()
mfrow3d(1, 2, sharedMouse = TRUE)

colorpal = c("#E41A1C", "#0066ff", "#4DAF4A", "#984EA3", "#FF7F00", "#FFFF33", "#A65628","#ff37cb","#66ff33", "#00ffff")

for (i in seq(1,2)){
  plot_df = filter(pwork_hrs, SEX == i)
  next3d()
  plot3d(plot_df[,c(1,2,5)],xlab ="Travel time to work", ylab ="Hours/Week", zlab = "Total Income", size = 2, type = "p", col = colorpal[i], zlim =c(0, 1.2*10^6))
}
```


```{r}
library(survey)
df = data.frame(pwork_hrs)
#add in Weight Columns
df$RAC1P = factor(df$RAC1P)
df$SEX = factor(df$RAC1P)

acsdesign<-svrepdesign(weights= ~PWGTP, repweights=df[,204:283], type="BRR", rscale = 4/80,data=df, combined=TRUE)

WKHP_mean = svymean(~WKHP, acsdesign, na.rm=T)
WKHP_quant = svyquantile(~WKHP, acsdesign, c(.25,.5,.75), na.rm=T)
            
JWMNP_mean = svymean(~JWMNP, acsdesign, na.rm=T)
JWMNP_quant = svyquantile(~JWMNP, acsdesign, c(.25,.5,.75), na.rm=T)

real_mean = svymean(~real, acsdesign, na.rm=T)
real_quant = svyquantile(~real, acsdesign, c(.25,.5,.75), na.rm=T)

summary(svyglm(real ~ SEX + JWMNP + WKHP + RAC1P, design = acsdesign))
```
Same results without survey package
Call:
svyglm(formula = PINCP ~ SEX + JWMNP + WKHP + RAC1P, design = acsdesign)

Survey design:
svrepdesign.default(weights = ~PWGTP, repweights = df[, 204:283], 
    type = "BRR", rscale = 4/80, data = df, combined = TRUE)

Coefficients:
              Estimate Std. Error  t value Pr(>|t|)    
(Intercept) -4.891e+03  2.647e+01  -184.79   <2e-16 ***
SEX2        -1.115e+04  1.159e+01  -961.33   <2e-16 ***
JWMNP        1.578e+02  3.081e-01   512.23   <2e-16 ***
WKHP         1.473e+03  5.975e-01  2465.68   <2e-16 ***
RAC1P2      -1.302e+04  1.557e+01  -836.15   <2e-16 ***
RAC1P3      -1.552e+04  4.315e+01  -359.60   <2e-16 ***
RAC1P4      -1.036e+04  3.503e+02   -29.56   <2e-16 ***
RAC1P5      -1.801e+04  1.086e+02  -165.79   <2e-16 ***
RAC1P6       7.326e+03  2.939e+01   249.22   <2e-16 ***
RAC1P7      -1.330e+04  1.364e+02   -97.53   <2e-16 ***
RAC1P8      -2.208e+04  2.140e+01 -1031.67   <2e-16 ***
RAC1P9      -9.345e+03  3.457e+01  -270.36   <2e-16 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for gaussian family taken to be 1324527377)

Using Adjustments

Coefficients:
              Estimate Std. Error t value Pr(>|t|)    
(Intercept) -2881.2046    29.4389  -97.87   <2e-16 ***
SEX2        -5899.1576    12.2888 -480.04   <2e-16 ***
JWMNP          44.9824     0.2766  162.63   <2e-16 ***
WKHP          751.2224     0.7243 1037.23   <2e-16 ***
RAC1P2       -580.9922    18.2472  -31.84   <2e-16 ***
RAC1P3      -7329.5696    51.8917 -141.25   <2e-16 ***
RAC1P4      -4971.6975   246.6691  -20.16   <2e-16 ***
RAC1P5      -6454.3314   106.1053  -60.83   <2e-16 ***
RAC1P6       4869.8039    36.2564  134.32   <2e-16 ***
RAC1P7      -3427.0917   129.6562  -26.43   <2e-16 ***
RAC1P8      -5871.2256    22.7408 -258.18   <2e-16 ***
RAC1P9      -1770.0703    36.1875  -48.91   <2e-16 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

